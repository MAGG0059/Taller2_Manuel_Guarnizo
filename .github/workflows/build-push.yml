name: Build and Push Docker Image

on:
  push:
    branches: [ develop, main ]
  pull_request:
    branches: [ develop ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Run tests (solo en develop)
        if: github.ref == 'refs/heads/develop'
        run: mvn test

      - name: Build Docker image
        run: |
          # Tag diferente segÃºn el branch
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            docker build -t manuelguarnizo/taller3:${{ github.sha }} .
            docker tag manuelguarnizo/taller3:${{ github.sha }} manuelguarnizo/taller3:latest
          else
            docker build -t manuelguarnizo/taller3:develop-${{ github.sha }} .
            docker tag manuelguarnizo/taller3:develop-${{ github.sha }} manuelguarnizo/taller3:develop-latest
          fi

      - name: Push to Docker Hub
        if: github.event_name == 'push'
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "ðŸš€ Pusheando imÃ¡genes de PRODUCCIÃ“N"
            docker push manuelguarnizo/taller3:${{ github.sha }}
            docker push manuelguarnizo/taller3:latest
          else
            echo "ðŸ§ª Pusheando imÃ¡genes de DEVELOP"
            docker push manuelguarnizo/taller3:develop-${{ github.sha }}
            docker push manuelguarnizo/taller3:develop-latest
          fi

      - name: Deploy to production (solo en main)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ðŸŽ¯ Desplegando en PRODUCCIÃ“N"
          echo "Imagen: manuelguarnizo/taller3:${{ github.sha }}"
          # AquÃ­ irÃ­an los comandos de despliegue a Kubernetes/Azure
          # kubectl set image deployment/taller3-api taller3-api=manuelguarnizo/taller3:${{ github.sha }}