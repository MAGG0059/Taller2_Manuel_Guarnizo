name: Build and Push Docker Image

on:
  push:
    branches: [ develop ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Verify JAR exists
        run: |
          echo "ğŸ“¦ Verificando JAR:"
          ls -la target/
          jar tf target/taller2-0.0.1-SNAPSHOT.jar | head -5

      - name: Build Docker image
        run: |
          echo "ğŸ—ï¸ Construyendo imagen Docker..."
          docker build -t manuelguarnizo/taller3:debug-${{ github.sha }} .
          
          echo "ğŸ“‹ Todas las imÃ¡genes locales:"
          docker images

      - name: Verify Docker image
        run: |
          echo "ğŸ” Inspeccionando imagen..."
          docker image inspect manuelguarnizo/taller3:debug-${{ github.sha }} --format '{{ .RepoTags }}'

      - name: Login to Docker Hub
        env:
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_PASS: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "ğŸ” Login a Docker Hub..."
          echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
          echo "âœ… Login exitoso"

      - name: Push to Docker Hub
        run: |
          echo "ğŸš€ Haciendo PUSH..."
          docker push manuelguarnizo/taller3:debug-${{ github.sha }}

      - name: Verify push
        run: |
          echo "âœ… Verificando en Docker Hub..."
          echo "ğŸ”— URL: https://hub.docker.com/r/manuelguarnizo/taller3/tags"
          sleep 10
          curl -s "https://hub.docker.com/v2/repositories/manuelguarnizo/taller3/tags/?page_size=10" | jq '.results[].name'

      - name: Show success with link
        run: |
          echo "ğŸ‰ Â¡Ã‰XITO! ImÃ¡genes pusheadas:"
          echo "   - manuelguarnizo/taller3:develop-${{ github.sha }}"
          echo "   - manuelguarnizo/taller3:develop-latest"
          echo ""
          echo "ğŸ”— VER IMÃGENES EN:"
          echo "   https://hub.docker.com/r/manuelguarnizo/taller3/tags"
          echo ""
          echo "ğŸ“± Para usar la imagen:"
          echo "   docker pull manuelguarnizo/taller3:develop-latest"
          echo "   docker run -p 3000:3000 manuelguarnizo/taller3:develop-latest"