name: Build and Push Docker Image

on:
  push:
    branches: [ develop ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Verify JAR exists
        run: |
          echo "ğŸ“¦ Verificando JAR:"
          ls -la target/
          jar tf target/taller2-0.0.1-SNAPSHOT.jar | head -5

      - name: Build Docker image
        run: |
          echo "ğŸ—ï¸ Construyendo imagen Docker..."
          docker build -t manuelguarnizo/taller3:develop-${{ github.sha }} .
          docker tag manuelguarnizo/taller3:develop-${{ github.sha }} manuelguarnizo/taller3:develop-latest
          
          echo "ğŸ“‹ Verificando imÃ¡genes construidas:"
          docker images | grep manuelguarnizo

      - name: Verify Docker image
        run: |
          echo "ğŸ” Inspeccionando imÃ¡genes..."
          docker image inspect manuelguarnizo/taller3:develop-${{ github.sha }} --format '{{ .RepoTags }}'
          docker image inspect manuelguarnizo/taller3:develop-latest --format '{{ .RepoTags }}'

      - name: Login to Docker Hub
        env:
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_PASS: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "ğŸ” Login a Docker Hub como: $DOCKER_USER"
          echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin

      - name: Push to Docker Hub
        run: |
          echo "ğŸš€ Haciendo PUSH de las imÃ¡genes..."
          echo "ğŸ“¦ Imagen a subir:"
          docker images | grep manuelguarnizo
          
          echo "ğŸ” Usuario actual de Docker:"
          cat ~/.docker/config.json | grep username || echo "No se pudo obtener username"
          
          echo "ğŸ·ï¸ Pusheando imÃ¡genes..."
          docker push manuelguarnizo/taller3:develop-${{ github.sha }}
          docker push manuelguarnizo/taller3:develop-latest

      - name: Verify push
        run: |
          echo "âœ… Verificando push en Docker Hub..."
          echo "ğŸ”— URL: https://hub.docker.com/r/manuelguarnizo/taller3/tags"
          sleep 15
          echo "ğŸ“¡ Consultando API de Docker Hub..."
          curl -s "https://hub.docker.com/v2/repositories/manuelguarnizo/taller3/tags/?page_size=10" | jq -r '.results[] | " - \(.name) (Ãºltima actualizaciÃ³n: \(.last_updated))"'

      - name: Show success with link
        run: |
          echo ""
          echo "ğŸ‰ âœ… IMÃGENES SUBIDAS EXITOSAMENTE"
          echo "======================================"
          echo "ğŸ“¦ ImÃ¡genes disponibles:"
          echo "    - manuelguarnizo/taller3:develop-${{ github.sha }}"
          echo "    - manuelguarnizo/taller3:develop-latest"
          echo ""
          echo "ğŸŒ VER IMÃGENES EN:"
          echo "   https://hub.docker.com/r/manuelguarnizo/taller3/tags"
          echo ""
          echo "ğŸš€ PARA USAR LA IMAGEN:"
          echo "   docker pull manuelguarnizo/taller3:develop-latest"
          echo "   docker run -p 3000:3000 manuelguarnizo/taller3:develop-latest"
          echo ""