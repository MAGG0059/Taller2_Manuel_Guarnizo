name: Build and Push Docker Image

on:
  push:
    branches: [ develop, main ]
  pull_request:
    branches: [ develop ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Run tests (solo en develop)
        if: github.ref == 'refs/heads/develop'
        run: mvn test

      - name: Build Docker image
        run: |
          # Tag diferente seg√∫n el branch
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            docker build -t manuelguarnizo/taller3:${{ github.sha }} .
            docker tag manuelguarnizo/taller3:${{ github.sha }} manuelguarnizo/taller3:latest
            docker tag manuelguarnizo/taller3:${{ github.sha }} manuelguarnizo/taller3:prod-${{ github.sha }}
          else
            docker build -t manuelguarnizo/taller3:develop-${{ github.sha }} .
            docker tag manuelguarnizo/taller3:develop-${{ github.sha }} manuelguarnizo/taller3:develop-latest
          fi

      - name: Test Docker image locally
        run: |
          echo "üß™ Probando imagen localmente..."
          docker run --rm -d -p 3000:3000 --name test-container manuelguarnizo/taller3:develop-${{ github.sha }}
          sleep 10
          docker stop test-container

      - name: Push to Docker Hub
        if: github.event_name == 'push'
        env:
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_PASS: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "üîê Login a Docker Hub..."
          echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
          
          echo "üì¶ Listando im√°genes locales..."
          docker images | grep manuelguarnizo
          
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "üöÄ Pusheando im√°genes de PRODUCCI√ìN"
            docker push manuelguarnizo/taller3:${{ github.sha }}
            docker push manuelguarnizo/taller3:latest
            docker push manuelguarnizo/taller3:prod-${{ github.sha }}
          else
            echo "üß™ Pusheando im√°genes de DEVELOP"
            docker push manuelguarnizo/taller3:develop-${{ github.sha }}
            docker push manuelguarnizo/taller3:develop-latest
          fi

      - name: Verify push
        if: github.event_name == 'push'
        run: |
          echo "‚úÖ Push completado - Verifica en:"
          echo "https://hub.docker.com/r/manuelguarnizo/taller3/tags"