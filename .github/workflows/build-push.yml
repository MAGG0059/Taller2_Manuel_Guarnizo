name: Build and Push Docker Image

on:
  push:
    branches: [ develop, main ]
  pull_request:
    branches: [ develop ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Run tests (solo en develop)
        if: github.ref == 'refs/heads/develop'
        run: mvn test

      - name: Build Docker image
        run: |
          # Tag diferente segÃºn el branch
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "ğŸ—ï¸ Construyendo imagen de PRODUCCIÃ“N"
            docker build -t manuelguarnizo/taller3:${{ github.sha }} .
            docker tag manuelguarnizo/taller3:${{ github.sha }} manuelguarnizo/taller3:latest
            docker tag manuelguarnizo/taller3:${{ github.sha }} manuelguarnizo/taller3:prod-${{ github.sha }}
          else
            echo "ğŸ—ï¸ Construyendo imagen de DEVELOP"
            docker build -t manuelguarnizo/taller3:develop-${{ github.sha }} .
            docker tag manuelguarnizo/taller3:develop-${{ github.sha }} manuelguarnizo/taller3:develop-latest
          fi

      - name: List Docker images
        run: docker images | grep manuelguarnizo

      - name: Push to Docker Hub
        if: github.event_name == 'push'
        env:
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_PASS: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "ğŸ” Login a Docker Hub..."
          echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
          
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "ğŸš€ Pusheando imÃ¡genes de PRODUCCIÃ“N"
            docker push manuelguarnizo/taller3:${{ github.sha }}
            docker push manuelguarnizo/taller3:latest
            docker push manuelguarnizo/taller3:prod-${{ github.sha }}
          else
            echo "ğŸ§ª Pusheando imÃ¡genes de DEVELOP"
            docker push manuelguarnizo/taller3:develop-${{ github.sha }}
            docker push manuelguarnizo/taller3:develop-latest
          fi

      - name: Verify push success
        if: github.event_name == 'push'
        run: |
          echo "âœ… Proceso completado"
          echo "ğŸ“¦ ImÃ¡genes disponibles en:"
          echo "https://hub.docker.com/r/manuelguarnizo/taller3/tags"